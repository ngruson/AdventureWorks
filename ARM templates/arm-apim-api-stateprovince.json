{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "apim-name": {
            "type": "string"
        }
    },
    "functions": [],
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.ApiManagement/service/apiVersionSets",
            "apiVersion": "2020-06-01-preview",
            "name": "[concat(parameters('apim-name'), '/stateprovince-api-version-set')]",
            "properties": {
                "displayName": "StateProvince API",
                "versioningScheme": "Segment"
            }
        },
        {
            "type": "Microsoft.ApiManagement/service/apis",
            "apiVersion": "2020-06-01-preview",
            "name": "[concat(parameters('apim-name'), '/stateprovince-api')]",
            "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service/apiVersionSets', parameters('apim-name'), 'stateprovince-api-version-set')]"
            ],
            "properties": {
                "displayName": "StateProvince API",
                "apiRevision": "1",
                "subscriptionRequired": true,
                "serviceUrl": "https://app-adventureworks-wcf-stateprovinceservice.azurewebsites.net/",
                "path": "stateprovince",
                "protocols": [
                    "https"
                ],
                "isCurrent": true,
                "apiVersion": "1.0",
                "apiVersionSetId": "[resourceId('Microsoft.ApiManagement/service/apiVersionSets', parameters('apim-name'), 'stateprovince-api-version-set')]"
            }
        },
        {
            "type": "Microsoft.ApiManagement/service/apis/operations",
            "apiVersion": "2020-06-01-preview",
            "name": "[concat(parameters('apim-name'), '/stateprovince-api/ListStateProvinces')]",
            "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apim-name'), 'stateprovince-api')]"
            ],
            "properties": {
                "displayName": "ListStateProvinces",
                "method": "GET",
                "urlTemplate": "/",
                "templateParameters": [],
                "description": "ListStateProvinces",
                "responses": [
                    {
                        "statusCode": 200,
                        "description": "IStateProvinceService_ListStateProvinces_OutputMessage",
                        "representations": [
                            {
                                "contentType": "application/json",
                                "sample": "{\r\n  \"stateProvinces\": [\r\n    {\r\n      \"countryRegionCode\": \"sample\",\r\n      \"stateProvinceCode\": \"sample\",\r\n      \"name\": \"sample\",\r\n      \"territoryName\": \"sample\"\r\n    }\r\n  ]\r\n}",
                                "typeName": "ListStateProvincesResponse"
                            }
                        ],
                        "headers": []
                    }
                ]
            }
        },
        {
            "type": "Microsoft.ApiManagement/service/apis/operations/policies",
            "apiVersion": "2020-06-01-preview",
            "name": "[concat(parameters('apim-name'), '/stateprovince-api/ListStateProvinces/policy')]",
            "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apim-name'), 'stateprovince-api', 'ListStateProvinces')]",
                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apim-name'), 'stateprovince-api')]"
            ],
            "properties": {
                "value": "<policies>\r\n  <inbound>\r\n    <base />\r\n    <rewrite-uri template=\"/StateProvinceService.svc\" copy-unmatched-params=\"false\" />\r\n    <set-method>POST</set-method>\r\n    <set-header name=\"SOAPAction\" exists-action=\"override\">\r\n      <value>\"ListStateProvinces\"</value>\r\n    </set-header>\r\n    <set-body template=\"liquid\">\r\n      <soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns=\"http://services.aw.com/StateProvinceService/1.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\r\n        <soap:Body>\r\n          <ListStateProvinces>\r\n            <request>\r\n                            {% if context.Request.OriginalUrl.Query.countryRegionCode != null %}\r\n                            <CountryRegionCode>{{context.Request.OriginalUrl.Query.countryRegionCode}}</CountryRegionCode>\r\n                            {% else %}\r\n                            <CountryRegionCode xsi:nil=\"true\" />\r\n                            {% endif %}\r\n                        </request>\r\n          </ListStateProvinces>\r\n        </soap:Body>\r\n      </soap:Envelope>\r\n    </set-body>\r\n    <set-header name=\"Content-Type\" exists-action=\"override\">\r\n      <value>text/xml</value>\r\n    </set-header>\r\n  </inbound>\r\n  <backend>\r\n    <base />\r\n  </backend>\r\n  <outbound>\r\n    <base />\r\n    <choose>\r\n      <when condition=\"@(context.Response.StatusCode &lt; 400)\">\r\n        <set-body template=\"liquid\">\r\n        {\r\n            \"stateProvinces\": \r\n            [\r\n                {% JSONArrayFor item in body.envelope.body.ListStateProvincesResponse.ListStateProvincesResult.StateProvinces -%}\r\n                {\r\n                    \"countryRegionCode\": {% if item.CountryRegionCode %}\"{{item.CountryRegionCode | Replace: '\\r', '\\r' | Replace: '\\n', '\\n' | Replace: '([^\\\\](\\\\\\\\)*)\"', '$1\\\"'}}\"{% else %} null {% endif %},\r\n                    \"stateProvinceCode\": {% if item.StateProvinceCode %}\"{{item.StateProvinceCode | Replace: '\\r', '\\r' | Replace: '\\n', '\\n' | Replace: '([^\\\\](\\\\\\\\)*)\"', '$1\\\"'}}\"{% else %} null {% endif %},\r\n                    \"name\": {% if item.Name %}\"{{item.Name | Replace: '\\r', '\\r' | Replace: '\\n', '\\n' | Replace: '([^\\\\](\\\\\\\\)*)\"', '$1\\\"'}}\"{% else %} null {% endif %},\r\n                    \"territoryName\": {% if item.TerritoryName %}\"{{item.TerritoryName | Replace: '\\r', '\\r' | Replace: '\\n', '\\n' | Replace: '([^\\\\](\\\\\\\\)*)\"', '$1\\\"'}}\"{% else %} null {% endif %}\r\n                }\r\n                {% endJSONArrayFor -%}\r\n            ]\r\n        }</set-body>\r\n      </when>\r\n      <otherwise>\r\n        <set-variable name=\"old-body\" value=\"@(context.Response.Body.As&lt;string&gt;(preserveContent: true))\" />\r\n        <!-- Error response as per https://github.com/Microsoft/api-guidelines/blob/master/Guidelines.md#7102-error-condition-responses -->\r\n        <set-body template=\"liquid\">{\r\n            \"error\": {\r\n                \"code\": \"{{body.envelope.body.fault.faultcode}}\",\r\n                \"message\": \"{{body.envelope.body.fault.faultstring}}\"\r\n            }\r\n        }</set-body>\r\n        <choose>\r\n          <when condition=\"@(string.IsNullOrEmpty(context.Response.Body.As&lt;JObject&gt;(preserveContent: true)[&quot;error&quot;][&quot;code&quot;].ToString()) &amp;&amp; string.IsNullOrEmpty(context.Response.Body.As&lt;JObject&gt;(preserveContent: true)[&quot;error&quot;][&quot;message&quot;].ToString()))\">\r\n            <set-body>@{\r\n                    var newResponseBody = new JObject();\r\n                    newResponseBody[\"error\"] = new JObject();\r\n                    newResponseBody[\"error\"][\"code\"] = \"InvalidErrorResponseBody\";\r\n                    if (string.IsNullOrEmpty((string)context.Variables[\"old-body\"]))\r\n                    {\r\n                        newResponseBody[\"error\"][\"message\"] = \"The error response body was not a valid SOAP error response. The response body was empty.\";\r\n                    }\r\n                    else\r\n                    {\r\n                        newResponseBody[\"error\"][\"message\"] = \"The error response body was not a valid SOAP error response. The response body was: '\" + context.Variables[\"old-body\"] + \"'.\";\r\n                    }\r\n                    return newResponseBody.ToString();\r\n                }</set-body>\r\n          </when>\r\n        </choose>\r\n      </otherwise>\r\n    </choose>\r\n    <set-header name=\"Content-Type\" exists-action=\"override\">\r\n      <value>application/json</value>\r\n    </set-header>\r\n  </outbound>\r\n  <on-error>\r\n    <base />\r\n  </on-error>\r\n</policies>",
                "format": "xml"
            }
        },
        {
            "type": "Microsoft.ApiManagement/service/apis/schemas",
            "apiVersion": "2020-06-01-preview",
            "name": "[concat(parameters('apim-name'), '/stateprovince-api/schemas')]",
            "dependsOn": [
                "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apim-name'), 'stateprovince-api')]"
            ],
            "properties": {
                "contentType": "application/vnd.ms-azure-apim.swagger.definitions+json",
                "document": {
                    "definitions": {
                        "ListStateProvincesResponse": {
                            "type": "object",
                            "properties": {
                                "stateProvinces": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "countryRegionCode": {
                                                "type": "string"
                                            },
                                            "stateProvinceCode": {
                                                "type": "string"
                                            },
                                            "name": {
                                                "type": "string"
                                            },
                                            "territoryName": {
                                                "type": "string"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    ],
    "outputs": {}
}